#!/usr/bin/env python3
"""
GraphCodeBERT Java‰ª£Á†ÅÂµåÂÖ•Á≥ªÁªüÂêØÂä®ËÑöÊú¨
"""

import os
import sys
import logging
import argparse
from pathlib import Path

# Ê∑ªÂä†È°πÁõÆÊ†πÁõÆÂΩïÂà∞PythonË∑ØÂæÑ
PROJECT_ROOT = Path(__file__).parent.absolute()
sys.path.insert(0, str(PROJECT_ROOT))

def setup_environment():
    """ËÆæÁΩÆÁéØÂ¢ÉÂèòÈáèÂíåË∑ØÂæÑ"""
    # ËÆæÁΩÆÁéØÂ¢ÉÂèòÈáè
    os.environ['PYTHONPATH'] = str(PROJECT_ROOT)
    
    # ÂàõÂª∫ÂøÖË¶ÅÁöÑÁõÆÂΩï
    directories = [
        PROJECT_ROOT / 'output',
        PROJECT_ROOT / 'logs',
        PROJECT_ROOT / 'chroma_db',
        PROJECT_ROOT / 'models'
    ]
    
    for directory in directories:
        directory.mkdir(exist_ok=True)
    
    print(f"‚úÖ ÁéØÂ¢ÉËÆæÁΩÆÂÆåÊàêÔºåÈ°πÁõÆÊ†πÁõÆÂΩï: {PROJECT_ROOT}")

def run_example():
    """ËøêË°åÁ§∫‰æã"""
    print("üöÄ ËøêË°åÁ§∫‰æãÁ®ãÂ∫è...")
    try:
        # Âä®ÊÄÅÂØºÂÖ•‰ª•ÈÅøÂÖçË∑ØÂæÑÈóÆÈ¢ò
        from example_usage import main as example_main
        example_main()
    except Exception as e:
        print(f"‚ùå ËøêË°åÁ§∫‰æãÂ§±Ë¥•: {e}")
        print("üí° ËØ∑Á°Æ‰øùÊâÄÊúâ‰æùËµñÂ∑≤Ê≠£Á°ÆÂÆâË£Ö")

def run_tests():
    """ËøêË°åÊµãËØï"""
    print("üß™ ËøêË°åÁ≥ªÁªüÊµãËØï...")
    try:
        from test_system import main as test_main
        test_main()
    except Exception as e:
        print(f"‚ùå ËøêË°åÊµãËØïÂ§±Ë¥•: {e}")
        print("üí° ËØ∑Á°Æ‰øùÊâÄÊúâ‰æùËµñÂ∑≤Ê≠£Á°ÆÂÆâË£Ö")

def run_main_system(args):
    """ËøêË°å‰∏ªÁ≥ªÁªü"""
    print("üéØ ÂêØÂä®‰∏ªÁ≥ªÁªü...")
    try:
        # Âä®ÊÄÅÂØºÂÖ•‰∏ªÁ≥ªÁªü
        from src.main import main as main_system
        
        # ËÆæÁΩÆÂëΩ‰ª§Ë°åÂèÇÊï∞
        original_argv = sys.argv
        sys.argv = ['main.py']
        
        if args.repo_path:
            sys.argv.extend(['--repo-path', args.repo_path])
        if args.output_file:
            sys.argv.extend(['--output-file', args.output_file])
        if args.interactive:
            sys.argv.append('--interactive')
        if args.vector_db:
            sys.argv.extend(['--vector-db', args.vector_db])
        if args.model_name:
            sys.argv.extend(['--model-name', args.model_name])
        if args.log_level:
            sys.argv.extend(['--log-level', args.log_level])
        
        # ËøêË°å‰∏ªÁ≥ªÁªü
        main_system()
        
        # ÊÅ¢Â§çÂéüÂßãÂèÇÊï∞
        sys.argv = original_argv
        
    except Exception as e:
        print(f"‚ùå ËøêË°å‰∏ªÁ≥ªÁªüÂ§±Ë¥•: {e}")
        import traceback
        traceback.print_exc()

def create_sample_java_project():
    """ÂàõÂª∫Á§∫‰æãJavaÈ°πÁõÆ"""
    print("üìÅ ÂàõÂª∫Á§∫‰æãJavaÈ°πÁõÆ...")
    
    sample_dir = PROJECT_ROOT / 'sample_java_project'
    sample_dir.mkdir(exist_ok=True)
    
    # ÂàõÂª∫ÂåÖÁªìÊûÑ
    (sample_dir / 'src' / 'main' / 'java' / 'com' / 'example' / 'model').mkdir(parents=True, exist_ok=True)
    (sample_dir / 'src' / 'main' / 'java' / 'com' / 'example' / 'service').mkdir(parents=True, exist_ok=True)
    (sample_dir / 'src' / 'main' / 'java' / 'com' / 'example' / 'controller').mkdir(parents=True, exist_ok=True)
    
    # ÂàõÂª∫JavaÊñá‰ª∂
    java_files = {
        'src/main/java/com/example/model/User.java': '''
package com.example.model;

import java.util.Objects;

public class User {
    private Long id;
    private String name;
    private String email;
    private int age;
    
    public User() {}
    
    public User(String name, String email, int age) {
        this.name = name;
        this.email = email;
        this.age = age;
    }
    
    public Long getId() {
        return id;
    }
    
    public void setId(Long id) {
        this.id = id;
    }
    
    public String getName() {
        return name;
    }
    
    public void setName(String name) {
        this.name = name;
    }
    
    public String getEmail() {
        return email;
    }
    
    public void setEmail(String email) {
        this.email = email;
    }
    
    public int getAge() {
        return age;
    }
    
    public void setAge(int age) {
        this.age = age;
    }
    
    public boolean isAdult() {
        return age >= 18;
    }
    
    @Override
    public boolean equals(Object obj) {
        if (this == obj) return true;
        if (obj == null || getClass() != obj.getClass()) return false;
        User user = (User) obj;
        return age == user.age && 
               Objects.equals(id, user.id) && 
               Objects.equals(name, user.name) && 
               Objects.equals(email, user.email);
    }
    
    @Override
    public int hashCode() {
        return Objects.hash(id, name, email, age);
    }
    
    @Override
    public String toString() {
        return "User{" +
                "id=" + id +
                ", name='" + name + '\\'' +
                ", email='" + email + '\\'' +
                ", age=" + age +
                '}';
    }
}
''',
        'src/main/java/com/example/service/UserService.java': '''
package com.example.service;

import com.example.model.User;
import java.util.*;

public class UserService {
    private List<User> users = new ArrayList<>();
    private Long nextId = 1L;
    
    public User createUser(String name, String email, int age) {
        User user = new User(name, email, age);
        user.setId(nextId++);
        users.add(user);
        return user;
    }
    
    public User findUserById(Long id) {
        return users.stream()
                   .filter(user -> user.getId().equals(id))
                   .findFirst()
                   .orElse(null);
    }
    
    public User findUserByEmail(String email) {
        return users.stream()
                   .filter(user -> user.getEmail().equals(email))
                   .findFirst()
                   .orElse(null);
    }
    
    public List<User> getAllUsers() {
        return new ArrayList<>(users);
    }
    
    public List<User> getAdultUsers() {
        return users.stream()
                   .filter(User::isAdult)
                   .collect(ArrayList::new, ArrayList::add, ArrayList::addAll);
    }
    
    public boolean updateUser(Long id, User updatedUser) {
        for (int i = 0; i < users.size(); i++) {
            if (users.get(i).getId().equals(id)) {
                updatedUser.setId(id);
                users.set(i, updatedUser);
                return true;
            }
        }
        return false;
    }
    
    public boolean deleteUser(Long id) {
        return users.removeIf(user -> user.getId().equals(id));
    }
    
    public long getUserCount() {
        return users.size();
    }
    
    public double getAverageAge() {
        return users.stream()
                   .mapToInt(User::getAge)
                   .average()
                   .orElse(0.0);
    }
}
''',
        'src/main/java/com/example/controller/UserController.java': '''
package com.example.controller;

import com.example.model.User;
import com.example.service.UserService;
import java.util.List;

public class UserController {
    private UserService userService;
    
    public UserController(UserService userService) {
        this.userService = userService;
    }
    
    public User createUser(String name, String email, int age) {
        if (name == null || name.trim().isEmpty()) {
            throw new IllegalArgumentException("Name cannot be null or empty");
        }
        if (email == null || email.trim().isEmpty()) {
            throw new IllegalArgumentException("Email cannot be null or empty");
        }
        if (age < 0) {
            throw new IllegalArgumentException("Age cannot be negative");
        }
        
        // Ê£ÄÊü•ÈÇÆÁÆ±ÊòØÂê¶Â∑≤Â≠òÂú®
        User existingUser = userService.findUserByEmail(email);
        if (existingUser != null) {
            throw new IllegalArgumentException("Email already exists: " + email);
        }
        
        return userService.createUser(name, email, age);
    }
    
    public User getUserById(Long id) {
        if (id == null) {
            throw new IllegalArgumentException("ID cannot be null");
        }
        return userService.findUserById(id);
    }
    
    public User getUserByEmail(String email) {
        if (email == null || email.trim().isEmpty()) {
            throw new IllegalArgumentException("Email cannot be null or empty");
        }
        return userService.findUserByEmail(email);
    }
    
    public List<User> getAllUsers() {
        return userService.getAllUsers();
    }
    
    public List<User> getAdultUsers() {
        return userService.getAdultUsers();
    }
    
    public boolean updateUser(Long id, String name, String email, int age) {
        if (id == null) {
            throw new IllegalArgumentException("ID cannot be null");
        }
        
        User existingUser = userService.findUserById(id);
        if (existingUser == null) {
            return false;
        }
        
        User updatedUser = new User(name, email, age);
        return userService.updateUser(id, updatedUser);
    }
    
    public boolean deleteUser(Long id) {
        if (id == null) {
            throw new IllegalArgumentException("ID cannot be null");
        }
        return userService.deleteUser(id);
    }
    
    public void printUserStatistics() {
        System.out.println("=== User Statistics ===");
        System.out.println("Total users: " + userService.getUserCount());
        System.out.println("Adult users: " + userService.getAdultUsers().size());
        System.out.println("Average age: " + String.format("%.2f", userService.getAverageAge()));
    }
}
'''
    }
    
    # ÂÜôÂÖ•Êñá‰ª∂
    for file_path, content in java_files.items():
        full_path = sample_dir / file_path
        with open(full_path, 'w', encoding='utf-8') as f:
            f.write(content.strip())
    
    print(f"‚úÖ Á§∫‰æãJavaÈ°πÁõÆÂ∑≤ÂàõÂª∫: {sample_dir}")
    return str(sample_dir)

def main():
    """‰∏ªÂáΩÊï∞"""
    parser = argparse.ArgumentParser(description="GraphCodeBERT Java‰ª£Á†ÅÂµåÂÖ•Á≥ªÁªüÂêØÂä®Âô®")
    parser.add_argument("--mode", choices=["test", "example", "main", "sample"], 
                       default="example", help="ËøêË°åÊ®°Âºè")
    parser.add_argument("--repo-path", help="Java‰ª£Á†Å‰ªìÂ∫ìË∑ØÂæÑ")
    parser.add_argument("--output-file", help="ËæìÂá∫Êñá‰ª∂Ë∑ØÂæÑ")
    parser.add_argument("--interactive", action="store_true", help="ÂêØÁî®‰∫§‰∫íÂºèÊ®°Âºè")
    parser.add_argument("--vector-db", choices=["chromadb", "faiss"], 
                       default="chromadb", help="ÂêëÈáèÊï∞ÊçÆÂ∫ìÁ±ªÂûã")
    parser.add_argument("--model-name", default="microsoft/graphcodebert-base", 
                       help="GraphCodeBERTÊ®°ÂûãÂêçÁß∞")
    parser.add_argument("--log-level", default="INFO", help="Êó•ÂøóÁ∫ßÂà´")
    
    args = parser.parse_args()
    
    # ËÆæÁΩÆÊó•Âøó
    logging.basicConfig(
        level=getattr(logging, args.log_level.upper()),
        format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
    )
    
    print("üöÄ GraphCodeBERT Java‰ª£Á†ÅÂµåÂÖ•Á≥ªÁªüÂêØÂä®Âô®")
    print("=" * 50)
    
    # ËÆæÁΩÆÁéØÂ¢É
    setup_environment()
    
    try:
        if args.mode == "test":
            run_tests()
        elif args.mode == "example":
            run_example()
        elif args.mode == "sample":
            sample_path = create_sample_java_project()
            print(f"\nüéØ Á§∫‰æãÈ°πÁõÆÂ∑≤ÂàõÂª∫ÔºåÂèØ‰ª•‰ΩøÁî®‰ª•‰∏ãÂëΩ‰ª§ÂàÜÊûê:")
            print(f"python run_project.py --mode main --repo-path {sample_path}")
        elif args.mode == "main":
            if not args.repo_path:
                print("‚ùå ‰∏ªÊ®°ÂºèÈúÄË¶ÅÊåáÂÆö --repo-path ÂèÇÊï∞")
                sample_path = create_sample_java_project()
                print(f"üí° Â∑≤ÂàõÂª∫Á§∫‰æãÈ°πÁõÆÔºå‰ΩøÁî®Ë∑ØÂæÑ: {sample_path}")
                args.repo_path = sample_path
            
            run_main_system(args)
        
    except KeyboardInterrupt:
        print("\nüõë Á®ãÂ∫èË¢´Áî®Êà∑‰∏≠Êñ≠")
    except Exception as e:
        print(f"‚ùå ËøêË°åÂ§±Ë¥•: {e}")
        import traceback
        traceback.print_exc()

if __name__ == "__main__":
    main() 